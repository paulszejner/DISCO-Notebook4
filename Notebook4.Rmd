---
title: "Sensitivity analysis Oxygen Isotopes in cellulose"
output: html_notebook
---
#####  Isotope Dendrochronology
#####  Mechanistic model of the Oxygen isotopes in cellulose.
#####  COURSE: DISC, LTRR, UNIVERSITY OF ARIZONA. INSTRUCTORS: P. SZEJNER & S. BELMECHER



## Instructions:

The following activities with R code and comments should further your experience using tree rings and Oxygen isotopes in cellulose using the R environment. This exercise relies upon multiples estimations to conduct a sensitivity analysis of how different factors affect the oxygen isotopes in the cellulose that we can measure in tree rings. The following calculations, like Notebook 2, will be relying on the use of the Craig Gordon model and the Roden model.

You will need to download the R project from https://github.com/paulszejner/Notebook-4.git 
then, each of you will be able to set your working directory to proceed with this exercises. Once you open the ```Notebook 4.Rproj```  you can open the ```Notebook 4.Rmd``` file to proceed with the activity.

I this exercise, you will model the oxygen isotopes in cellulose. However, this exercise is intended for you to evaluate the sensitivity of the different variables. For example, what happens to the cellulose oxygen isotopes if we vary the relative humidity ```relH```,  the source water ```water```, and the percentage of exchange during the cellulose sinthesys```F_0```




## PART 1: Variables to analize its sensitivity

Here we will create a vector of Relative Humidity that will go from 10% to 80% ```relH```  
The Source water will vary form -20 to -5 and will create a vector called ```water```
After setting the range of conditions in which the model will run, we will produce all the combinations for each condition
and will produce a 2 column object with all Relative humidities  for each source water we have. ```RH_SOURCE```

```{r}

relH <- seq(10, 90, by=5) # this is the vector of 17 different Realtive humidieties
water <-seq( -25, 5,by = 2) # this is the vector with all 16 the isotopic values from the water sources. 


RH_SOURCE <- merge(relH, water) # here we merge the two variables to  facilitate the calculations on each row of this object.

stem_18O <- RH_SOURCE[,2]
Source_18O <- RH_SOURCE[,2]


```

## PART 2: Modeling the

```{r}
# Sensitivity analysis on Variations in the isotopes in Vapor on Lead Water
# the idea is to have a temperature dependent vapor isotopes  such as V=Sourse-E*
# E* = Fractionation from fase change
# rm(list=ls())

# Constants ---------------------------------------------------------------

# stomatal 	 conductance   (mol m-2 s-1) 
# gs <- 0.19  #considered reasonable value between 0.001 to 1 in Roden paper
# boundary layer cond. (mol m-2 s-1)


br <-1 #considered reasonable value between 0.02 to 3 in Roden paper boundary layer resistance    
ak <- 1.0285	# alpha_kappa, Kinetic Fractionation 
akb <- 1.0189	# alpha_kappa_beta, Kinetic Fractionation boundary layer
rsmow <- 0.0020052 # Oxygen Isotope ratio from STANDARD	SMOV
epsilon_s <-  27 #Autotrophic fractionation Sucrose	
epsilon_c <- 27	# Autotrophic fractionation Cellulose ## 0.0084*Tmin.ts^2-0.51*Tmin.ts+ 33.172 


library(dplyr)

############################################# CALCULATIONS 
###### IMPORTANT TO CHANGE THE INPUT TO THE LEVEL CONSIDERED AND SOURCE 18O CONSIDERED#####################

# barometric	pressure  (mmbar)  
press_bar <- 77 #a good site average is 77.5 according to W, This need to be changed for the pressure level
# source   d18O  water  (‰)   Change this depending on soil or P
#Source_18O <- -14.46825
# stem  water, d18O (‰)  
#stem_18O <- Source_18O# or any  modeled Stem water taking in consi. some enrichment before water uptake
# air	temp. (°C)  Assumption that Tleaf= T air
Ta <- 25
#Ta=Tmin.ts
# relative humidity  (%) 


# IMPORTANT TO CHANGE THE INPUT TO THE LEVEL CONSIDERED AND SOURCE 18O CONSIDERED######################

#d18O of water vapor ··· chek this thingi
#I should be usingf the soil water and build a upper boundary to the vapor frac

d18O_W <- Source_18O+ (-1*(1.137*(1000000/((Ta+273.15)^2))-0.4156*((1000/(Ta+273.15))-2.0667)))
water_vapor <-  Source_18O +(-1*(1.137*(1000000/((Ta+273.15)^2))-0.4156*((1000/(Ta+273.15))-2.0667))) 

# where this formula comes from 
```
```{r}

plot(RH_SOURCE[,2],d18O_W)


plot(RH_SOURCE[,1],d18O_W)


```

``` {r}
# esat saturation vapor pressure (kPa) with air temp

es=(101325*exp((((-0.1299*(1-(373.16/(273.15 + Ta)))-0.6445)*
                   (1-(373.16/(273.15 + Ta)))-1.976)*(1-(373.16/(273.15 + Ta)))+13.3185)
               *(1-(373.16/(273.15 + Ta)))))/1000

#ea ambient vapor pressure (kPa)

RH_v <- RH_SOURCE[,1]

ea_v =(RH_v/100)*es


ea_vpd =es-ea_v
```


``` {r}
plot(RH_SOURCE[,1],ea_v)
plot(RH_SOURCE[,1],ea_vpd)
```


``` {r}
# ei leaf vapor pressure (kPa) is es. ei=es


 ei =(101325*exp((((-0.1299*(1-(373.16/(273.15 + Ta)))-0.6445)*
                    (1-(373.16/(273.15 + Ta)))-1.976)*(1-(373.16/(273.15 + Ta)))+13.3185)
                *(1-(373.16/(273.15 + Ta)))))/1000


# g, total leaf conductance to water vapor (mol m-2 s-1) 
#convert VPD from Hpa to kPa to apply the relationship of McDowell 2008 (Ecohydrology)/1000
#gs <- 0.03 #283.2*exp(-1.15*(VPD/10))/1000 ### (day 180 0.1  day240 to 0.03)

gs <- seq(0.01,0.5,length.out = 5)


#Total Conductance in mol
g = 1/(1/gs + 1/br) # or 1/(rs+rb)




# E leaf transpiration (mol m-2 s-1) # barbour 2004
# this list contains 5 diferent combinations of gs  on a 16 different temperatures  for many RH and Source water.
E_v_gs <- list()
W_v_gs <- list()

for(sto in 1:5){
  E_v_gs[[sto]]=((ei-ea_v)/press_bar)*g[sto]
  W_v_gs[[sto]] <- ((ei-ea_v)/press_bar)
  }

str(E_v_gs)### list of model output based on 5 stomatal conductances,
```


``` {r}

plot(unlist( E_v_gs)*1000)
```


``` {r}
mean((ei-ea_v)/press_bar)

range(W_v_gs)
range(E_v_gs)

plot(W_v_gs[[1]],E_v_gs[[1]],type="l", xlim = range(W_v_gs), range(E_v_gs),ylab="E, mol m-2 s-1", xlab="mole fraction of water vapor deficit")
lines(W_v_gs[[3]],E_v_gs[[3]], lwd=3)
lines(W_v_gs[[5]],E_v_gs[[5]], lwd=6)

gs

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))


plot(RH_SOURCE[,1],E_v_gs[[1]],type="l", xlim = c(10,90), range(E_v_gs), ylab="E, mol m-2 s-1", xlab="rel Humidity")
lines(RH_SOURCE[,1],E_v_gs[[3]], lwd=3)
lines(RH_SOURCE[,1],E_v_gs[[5]], lwd=6)

gs

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```


``` {r}
#wi,  leaf water vapor, mole fraction


wi=ei/press_bar

#wa, ambient water vapor, mole fraction

 wa_v= ea_v/press_bar

plot(RH_SOURCE[,1],wa_v)

#ws, leaf surface water vapor, mole frac Roden 2000, Ball (1987),
# this list contains 5 diferent combinations of gs  on a 16 different temperatures  for many RH and Source water.
ws_v_gs <- list()
for(sto in 1:5){
  ws_v_gs[[sto]] =((gs[[sto]]*wi)-E_v_gs[[sto]]*(1 -wi/2))/(gs[[sto]] - E_v_gs[[sto]]/2)

}

###  5 gs, 16 temps


plot(ws_v_gs[[1]],E_v_gs[[1]],type="l", xlim = c(0,0.05), ylim=c(0,0.015), ylab="E, mol m-2 s-1", xlab=" leaf surface water vapor, mole frac")
lines(ws_v_gs[[3]],E_v_gs[[3]], lwd=3)
lines(ws_v_gs[[5]],E_v_gs[[5]], lwd=6)


legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))



# es vapor pressure at leaf surface (kPa)
esl_v_gs <- list()
for(sto in 1:5){
  esl_v_gs[[sto]]=ws_v_gs[[sto]]*press_bar
  }

plot(esl_v_gs[[1]],E_v_gs[[1]],type="l", xlim = c(0,3), ylim=c(0,0.015), ylab="E, mol m-2 s-1", xlab=" leaf surface water vapor, mole frac")
lines(esl_v_gs[[3]],E_v_gs[[3]], lwd=3)
lines(esl_v_gs[[5]],E_v_gs[[5]], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```


``` {r}
# a*  **equilibrium fractionation at leaf temperature  
# The equilibrium fractionation factor, a* is temperature dependent 
# (see Majoube, 1971, J. Chim. Phys. 58:1423-1436)
alpha_star =exp((1.137*1000/(273.15+Ta)^2)-(0.4156/(273.15+Ta))-0.0020667)
#R source O  isotope ratio, source water

Rsource= rsmow*(1+Source_18O/1000)
Rxyl= rsmow*(1+stem_18O/1000)
#R atm  Oxy  isotope ratio, atmosph  water vapor

Ratm= rsmow*(1+d18O_W/1000)

#R leaf model Oxyg  isotope ratio, leaf water GC
#### Leaf water enrichment  with diferent RH, Soueces and GS

Rleaf_v_gs <- list()
for(sto in 1:5){
  Rleaf_v_gs[[sto]] <- alpha_star[te]*((ak*Rxyl*
                              ((ei-esl_v_gs[[sto]])/ei))+
                             (akb*Rxyl*(esl_v_gs[[sto]]-ea_v)/ei)+
                             (Ratm*ea_v/ei))
  }


plot(W_v_gs [[1]],E_v_gs[[1]],type="l", xlim = c(0,0.04), ylim=c(0,0.015), ylab="E, mol m-2 s-1", xlab="mole fraction of water vapor deficit")
lines(W_v_gs [[3]],E_v_gs[[3]], lwd=3)
lines(W_v_gs [[5]],E_v_gs[[5]], lwd=6)
legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))


gs


plot(esl_v_gs[[1]],Rleaf_v_gs[[1]],type="l", xlim = c(0,4), ylab="E, mol m-2 s-1", xlab="mole fraction of water vapor deficit")
lines(esl_v_gs[[3]],Rleaf_v_gs[[3]], lwd=3)
lines(esl_v_gs[[5]],Rleaf_v_gs[[5]], lwd=6)


d18Oatm=((Ratm/rsmow)-1)*1000
```


``` {r}
#d18O leaf with CG so 5 Stomatal conductances  
#### Leaf water enrichment  with diferent RH, Soueces and GS
d18OL_gs <- list()
for(sto in 1:5){
  d18OL_gs[[sto]]=((Rleaf_v_gs[[sto]]/rsmow)-1)*1000 
}

## Plot with different source waters
# [1:13] is all RHs and  with source water of -25
plot(RH_v[1:13], d18OL_gs[[1]][1:13], type="l", ylim = c(-20,30))
lines(RH_v[1:13], d18OL_gs[[2]][1:13])
lines(RH_v[1:13], d18OL_gs[[3]][1:13])
lines(RH_v[1:13], d18OL_gs[[4]][1:13])
lines(RH_v[1:13], d18OL_gs[[5]][1:13])

# [1:13] is all RHs and  with source water of -10 permill
points(RH_v[196:208], d18OL_gs[[1]][196:208], pch=19)
points(RH_v[196:208], d18OL_gs[[2]][196:208], pch=19)
points(RH_v[196:208], d18OL_gs[[3]][196:208], pch=19)
points(RH_v[196:208], d18OL_gs[[4]][196:208], pch=19)
points(RH_v[196:208], d18OL_gs[[5]][196:208], pch=19)


plot(RH_v, d18OL_gs[[1]])
points(RH_v, d18OL_gs[[5]])
plot(RH_SOURCE[,2], d18OL_gs[[1]])
points(RH_SOURCE[,2], d18OL_gs[[5]])
```


``` {r}
#### Leaf water enrichment  with diferent RH, Soueces and GS

#Craig_Gordon model with different PEX
## on to the cellulose synthesis

F_0 <- c(0.33,0.42,0.55) # variable percentage of Exchage during Cellulose Synthesis
# here a double loop
d18Oc_F_0_gs <- list()
for(sto in 1:5){
  d18Oc_F_0 <- list()
  for (pe in 1:3){
    d18Oc_F_0[[pe]] <- F_0[[pe]]*(stem_18O + epsilon_c) + (1 - F_0[[pe]]) * (d18OL_gs[[sto]]+ epsilon_c) 
    }
d18Oc_F_0_gs[[sto]] <- d18Oc_F_0
}

str(d18Oc_F_0_gs)  # here we see we just generate a list of 5 stomatal conductance variations and in each of those 3 diferent outputs using different Percentage of exchange during cellulose sinthesisi.

```

## PART 3: Plotting results

```{r}

```

## PART 2: leaf water isotopic enrichment  

Now that we have our source water and estimate the water vapor, then, we can focus on what will happen to this water at the leaf during transpiration.  

The leaf water isotopic enrichment can be estimated using the Craig Gordon model of leaf water enrichment. This is because isotope values in the water inside the leaf are exposed to evaporation. The isotopic values of the reminding water inside the leaf will have a different isotopic value from the source value. This process will be highly dependent on the relative humidity, and we can apply the Craig Gordon model to estimate the isotopic values at the leaf level under certain relative humidity temperatures and stomatal conductance.  

