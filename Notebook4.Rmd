---
title: "Sensitivity analysis Oxygen Isotopes in cellulose"
output: html_notebook
---
#####  Isotope Dendrochronology
#####  Mechanistic model of the Oxygen isotopes in cellulose.
#####  COURSE: DISC, LTRR, UNIVERSITY OF ARIZONA. INSTRUCTORS: P. SZEJNER & S. BELMECHER



### Instructions:

The following activities with R code and comments should further your experience using tree rings and Oxygen isotopes in cellulose using the R environment. This exercise relies upon multiples estimations to conduct a sensitivity analysis of how different factors affect the oxygen isotopes in the cellulose that we can measure in tree rings. The following calculations, like Notebook 2, will be relying on the use of the Craig Gordon model and the Roden model.

You will need to download or clone the R project from https://github.com/paulszejner/DISCO-Notebook4.git
then, each of you will be able to set your working directory to proceed with this exercises. Once you open the ```Notebook 4.Rproj```  you can open the ```Notebook 4.Rmd``` file to proceed with the activity.

In this exercise, you will model the oxygen isotopes in cellulose ```d18O_cellulose```. However, this exercise is intended for you to evaluate the sensitivity of the different variables. For example, what happens to the cellulose oxygen isotopes if we vary the relative humidity ```relH```,  the source water ```water```, the stomatal conductance```gs``` and the percentage of exchange during the cellulose sinthesys```F_0```


## PART 1: Variables to analize its sensitivity

Here you will create a vector of relative humidity that will go from 10% to 90% ```relH```  
The Source water will vary from -20 to 5 and will create a vector called ```water```
After setting the range of conditions in which the model will run, we will produce all the combinations for each condition
and will create a 2 column object with all Relative humidities  for each source water we have. ```RH_SOURCE```

```{r}
#library(dplyr)

relH <- seq(10, 90, by=5) # this is the vector of 17 different Realtive humidieties
water <-seq( -25, 5,by = 2) # this is the vector with all 16 the isotopic values from the water sources. 

RH_SOURCE <- merge(relH, water) # here we merge the two variables to  facilitate the calculations on each row of this object.

Source_18O <- RH_SOURCE[,2]
Relative_humidity <- RH_SOURCE[,1]
plot(Relative_humidity, Source_18O)
```
So, we will run the model on all of these options between relative humidity and source water.


## PART 2: Modeling the Oxygen Isotopes in the tree ring cellulose

The following code will guide you step by step through the several isotopic fractionation processes inside the leaf, and during cellulose synthesis. In this occasion, we will run the model using an extensive range of variability on the four critical factors in the model.

```{r}
# Constants ---------------------------------------------------------------
br <-1 # boundary layer resistance, considered reasonable value between 0.02 to 3    
ak <- 1.0285	# alpha_kappa, Kinetic Fractionation 
akb <- 1.0189	# alpha_kappa_beta, Kinetic Fractionation boundary layer
rsmow <- 0.0020052 # Oxygen Isotope ratio from STANDARD	SMOV
epsilon_s <-  27 #Autotrophic fractionation Sucrose	
epsilon_c <- 27	# Autotrophic fractionation Cellulose
press_bar <- 77 # barometric	pressure  (mmbar) This need to be changed for the pressure level
Ta <- 25 # In this exercise, we are using a constant temperature, air temp. (Â°C)  Assumption that Tleaf= Tair
```


``` {r}

water_vapor <-  Source_18O +(-1*(1.137*(1000000/((Ta+273.15)^2))-0.4156*((1000/(Ta+273.15))-2.0667))) 
# where this formula comes from?

# es saturation vapor pressure (kPa) with air temp in this case at 25
es=(101325*exp((((-0.1299*(1-(373.16/(273.15 + Ta)))-0.6445)*
                   (1-(373.16/(273.15 + Ta)))-1.976)*(1-(373.16/(273.15 + Ta)))+13.3185)*(1-(373.16/(273.15 + Ta)))))/1000


# ea_v ambient vapor pressure (kPa)
RH_v <- RH_SOURCE[,1]
ea_v =(RH_v/100)*es
```


``` {r}
plot(RH_SOURCE[,1],ea_v, xlab = "relative humidity",ylab = "ambient vapor pressure (kPa)" )
```

Describe this relationship:  
-  
-  
-  
-  
-  
-  


``` {r}
# ei,  internal leaf vapor pressure (kPa) is es. ei=es,  because we assume that the vapor is saturated inside the leaf.
 ei=es

# g, total leaf conductance to water vapor (mol m-2 s-1) 
# this section is important becasue we are adding a new variable which we willl modify and add an other dimention to the sensitivity analysis,

gs <- c(0.01,0.25, 0.5)

#Total Conductance in mol
g = 1/(1/gs + 1/br) # or 1/(rs+rb)

# E_v_gs leaf transpiration (mol m-2 s-1) # barbour 2004
# this list contains 5 diferent combinations of gs  on a 16 different temperatures  for many RH and Source water.
E_v_gs <- list()
W_v_gs <- list() # dont know if we will use this

#this for loop will calculate the leaf transpiration and the W_v_gs for the 5 different gs
for(sto in 1:3){
  E_v_gs[[sto]]=((ei-ea_v)/press_bar)*g[sto] #(vpd*gs)=E
  W_v_gs[[sto]] <- ((ei-ea_v)/press_bar) # this is VPD? need to check on the units.
  }
# check the  structure of this new object.
str(E_v_gs)### list of model output based on 5 stomatal conductances,
```


``` {r}
plot(unlist( E_v_gs)*1000, xlab = " different observations, with 5 diferent gs ", ylab = "leaf transpiration (mol m-2 s-1)")
```
Describe this plot:  
-  
-  
-  
-  
-  
-  

``` {r}
plot(W_v_gs[[1]],E_v_gs[[1]],type="l", xlim = range(W_v_gs), range(E_v_gs),
     ylab="E, mol m-2 s-1", 
     xlab="mole fraction of water vapor deficit")
lines(W_v_gs[[2]],E_v_gs[[2]], lwd=3)
lines(W_v_gs[[3]],E_v_gs[[3]], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```
Describe this plot:  
-  
-  
-  
-  
-  
-  

``` {r}
plot(RH_SOURCE[,1],E_v_gs[[1]],type="l", xlim = c(10,90), range(E_v_gs), ylab="E, mol m-2 s-1", xlab="rel Humidity")
lines(RH_SOURCE[,1],E_v_gs[[2]], lwd=3)
lines(RH_SOURCE[,1],E_v_gs[[3]], lwd=6)
legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```
Describe this plot:  
-  
-  
-  
-  
-  
-  

``` {r}
wi=ei/press_bar #wi,  leaf water vapor, mole fraction
wa_v= ea_v/press_bar #wa, ambient water vapor, mole fraction


# ws_v_gs, leaf surface water vapor, mole frac Roden 2000, Ball (1987),
# this list contains 5 diferent combinations of gs for many RH and Source waters.

ws_v_gs <- list()
for(sto in 1:3){
  ws_v_gs[[sto]] =((gs[[sto]]*wi)-E_v_gs[[sto]]*(1-wi/2))/(gs[[sto]] - E_v_gs[[sto]]/2)

}
```


``` {r}
###  

plot(ws_v_gs[[1]],E_v_gs[[1]],type="l", xlim = c(0,0.05), ylim=c(0,0.015), ylab="E, mol m-2 s-1", xlab=" leaf surface water vapor, mole frac")
lines(ws_v_gs[[2]],E_v_gs[[2]], lwd=3)
lines(ws_v_gs[[3]],E_v_gs[[3]], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```

Describe this plot:  
-  
-  
-  
-  
-  
-  
``` {r}
# es vapor pressure at leaf surface (kPa)
esl_v_gs <- list()
for(sto in 1:3){
  esl_v_gs[[sto]]=ws_v_gs[[sto]]*press_bar
  }

plot(esl_v_gs[[1]],E_v_gs[[1]],type="l", xlim = c(0,3), ylim=c(0,0.015), ylab="E, mol m-2 s-1", xlab=" leaf surface water vapor, mole frac")
lines(esl_v_gs[[2]],E_v_gs[[2]], lwd=3)
lines(esl_v_gs[[3]],E_v_gs[[3]], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```
Describe this plot:  
-  
-  
-  
-  
-  
-  

Because we already have calculations for internal leaf vapor pressure (kPa)```ei```, vapor pressure at leaf surface (kPa) ```esl_v_gs```, ambient vapor pressure (kPa)```ea_v```  under different Stomatal conductances ```gs```, and different relative humidities```relH``` and, source waters ```water```. Thus, we have all the components to estimate the magnitude of the isotopic enrichment at the leaf level. 

``` {r}
# a*  **equilibrium fractionation at leaf temperature  
# The equilibrium fractionation factor, a* is temperature dependent 
# (see Majoube, 1971, J. Chim. Phys. 58:1423-1436), thus,
alpha_star =exp((1.137*1000/(273.15+Ta)^2)-(0.4156/(273.15+Ta))-0.0020667)

#R source O  isotope ratio, source water conversion to R notation
Rsource= rsmow*(1+Source_18O/1000)

#Ratm  Oxy  isotope ratio, atmosph  water vapor
Ratm= rsmow*(1+water_vapor/1000)

#R leaf model Oxyg  isotope ratio, leaf water GC
#### Leaf water enrichment  with diferent RH, Soueces and gs

Rleaf_v_gs <- list()
for(sto in 1:3){
  Rleaf_v_gs[[sto]] <- alpha_star*((ak*Rsource*
                              ((ei-esl_v_gs[[sto]])/ei))+
                             (akb*Rsource*(esl_v_gs[[sto]]-ea_v)/ei)+
                             (Ratm*ea_v/ei))
  }
```


``` {r}
plot(esl_v_gs[[1]][1:17],Rleaf_v_gs[[1]][1:17],type="p", xlim = c(0,4), ylab="leaf water GC", xlab="vapor pressure at leaf surface (kPa)")
points(esl_v_gs[[2]][1:17],Rleaf_v_gs[[2]][1:17], lwd=3)
points(esl_v_gs[[3]][1:17],Rleaf_v_gs[[3]][1:17], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))

```
Describe this plot:  
-  
-  
-  
-  
-  
-  

``` {r}
#d18O leaf with CG so 3 Stomatal conductances  
#### Leaf water enrichment  with diferent RH, Soueces and GS
d18OL_gs <- list()
for(sto in 1:3){
  d18OL_gs[[sto]]=((Rleaf_v_gs[[sto]]/rsmow)-1)*1000 
}
```

```{r}
plot(esl_v_gs[[1]][1:17],d18OL_gs[[1]][1:17],type="p", xlim = c(0,4), ylab="leaf water GC", xlab="vapor pressure at leaf surface (kPa)")
points(esl_v_gs[[2]][1:17],d18OL_gs[[2]][1:17], lwd=3)
points(esl_v_gs[[3]][1:17],d18OL_gs[[3]][1:17], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```

``` {r}
## Plot with different source waters
# [1:13] is all RHs and  with source water of -25
plot(RH_v[1:17], d18OL_gs[[1]][1:17], type="l", ylim = c(-30,10))
lines(RH_v[1:17], d18OL_gs[[2]][1:17], lwd=3)
lines(RH_v[1:17], d18OL_gs[[3]][1:17], lwd=6)

legend("topright", legend = c("gs=0.01","gs=0.25","gs=0.5" ), lwd = c(1,3,6))
```


``` {r}

#Craig_Gordon model with different PEX
## on to the cellulose synthesis

F_0 <- c(0.33,0.42,0.55) # variable percentage of Exchage during Cellulose Synthesis
# here a double loop
d18O_cellulose <- list()
for(sto in 1:3){
  d18Oc_F_0 <- list()
  for (pe in 1:3){ # variable percentage of Exchage during Cellulose Synthesis
    d18Oc_F_0[[pe]] <- F_0[[pe]]*(Source_18O + epsilon_c) + (1 - F_0[[pe]]) * (d18OL_gs[[sto]]+ epsilon_c) 
  }
  names(d18Oc_F_0) <- c("gs=0.01","gs=0.25","gs=0.5" )
d18O_cellulose[[sto]] <- d18Oc_F_0
}
names(d18O_cellulose) <- c("fo=0.33","fo=0.42","fo=0.55" )
str(d18O_cellulose)  # here we see we just generate a list of 3 stomatal conductance variations and in each of those 3 diferent outputs using different Percentage of exchange during cellulose sinthesisi.

```
Remember that each vector on these elements  of the list are al the  combinations we had at the  start of this exercise. where ```RH_SOURCE``` is the main structre for all 17 different Realtive humidietieson ```relH``` the 16 different source waters ```water``` provides 272 values on each vector from the list.

## PART 3: Estimate the  slope between  diferent variables  and the Isotopic effect estimated in cellulose 
In this final step you will need to estimate the diferent sensitivities the ```d18O_cellulose``` is exposed to  under diferent environments and diferent factors. and you will need to arrive to the conclusion which  of the factors  analized in this exercise is the most sensitive  and why. 


```{r}

## set the fraction of the vector we liket to plot  
source1 <- RH_SOURCE[,2]==-25 # in this case we select the  positions  that  have a sorce water of -25 
source2 <- RH_SOURCE[,2]==1# in this case we select the  positions  that  have a sorce water of 1 


plot(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.55"]][["gs=0.01"]][source2], xlim =range(RH_SOURCE[,1]), ylim =range(unlist(d18O_cellulose)),  pch=19) 
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.55"]][["gs=0.25"]][source2], pch=2)
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.55"]][["gs=0.5"]][source2])
  
  
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.33"]][["gs=0.01"]][source2],  pch=19, col="red" )
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.33"]][["gs=0.25"]][source2], pch=2, col="red" )
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.33"]][["gs=0.5"]][source2], col="red" )

  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.42"]][["gs=0.01"]][source2],  pch=19, col="blue" )
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.42"]][["gs=0.25"]][source2], pch=2, col="blue" )
  points(RH_SOURCE[,1][source2],d18O_cellulose[["fo=0.42"]][["gs=0.5"]][source2], col="blue" )

  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.55"]][["gs=0.01"]][source1],  pch=19, col="red" )
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.55"]][["gs=0.25"]][source1], pch=2)
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.55"]][["gs=0.5"]][source1])
  
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.33"]][["gs=0.01"]][source1],  pch=19, col="red" )
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.33"]][["gs=0.25"]][source1], pch=2, col="red" )
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.33"]][["gs=0.5"]][source1], col="red" )

  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.42"]][["gs=0.01"]][source1],  pch=19, col="blue" )
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.42"]][["gs=0.25"]][source1], pch=2, col="blue" )
  points(RH_SOURCE[,1][source1],d18O_cellulose[["fo=0.42"]][["gs=0.5"]][source1], col="blue" )
  
  
```




```{r}
RH1 <- RH_SOURCE[,1]== 10 # in this case we select the  positions  that  have a sorce water of -25 
RH2 <- RH_SOURCE[,1]==90# in this case we select the  positions  that  have a sorce water of 1 


plot(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.55"]][["gs=0.01"]][RH2], xlim =range(RH_SOURCE[,2]), ylim =range(unlist(d18O_cellulose)),  pch=19)
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.55"]][["gs=0.25"]][RH2], pch=2)
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.55"]][["gs=0.5"]][RH2])
  
  
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.33"]][["gs=0.01"]][RH2],  pch=19, col="red" )
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.33"]][["gs=0.25"]][RH2], pch=2, col="red" )
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.33"]][["gs=0.5"]][RH2], col="red" )

  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.42"]][["gs=0.01"]][RH2],  pch=19, col="blue" )
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.42"]][["gs=0.25"]][RH2], pch=2, col="blue" )
  points(RH_SOURCE[,2][RH2],d18O_cellulose[["fo=0.42"]][["gs=0.5"]][RH2], col="blue" )
  

  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.55"]][["gs=0.01"]][RH1],  pch=19, col="red" )
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.55"]][["gs=0.25"]][RH1], pch=2)
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.55"]][["gs=0.5"]][RH1])
  
  
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.33"]][["gs=0.01"]][RH1],  pch=19, col="red" )
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.33"]][["gs=0.25"]][RH1], pch=2, col="red" )
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.33"]][["gs=0.5"]][RH1], col="red" )

  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.42"]][["gs=0.01"]][RH1],  pch=19, col="blue" )
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.42"]][["gs=0.25"]][RH1], pch=2, col="blue" )
  points(RH_SOURCE[,2][RH1],d18O_cellulose[["fo=0.42"]][["gs=0.5"]][RH1], col="blue" )
  
  



```

in this final step  we will  plor aall in figure with all the values  estimated in this excersice
a 3 by 3 panel  using heat maps of the  RH,Source vectors


```{r}
#generation of matrices 17 different Realtive by 16 different waters

d18O__fo0.55_gs0.01 <- matrix (d18O_cellulose[["fo=0.55"]][["gs=0.01"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.55_gs0.25 <- matrix (d18O_cellulose[["fo=0.55"]][["gs=0.25"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.55_gs0.5 <- matrix (d18O_cellulose[["fo=0.55"]][["gs=0.5"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))

d18O__fo0.33_gs0.01 <- matrix (d18O_cellulose[["fo=0.33"]][["gs=0.01"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.33_gs0.25 <- matrix (d18O_cellulose[["fo=0.33"]][["gs=0.25"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.33_gs0.5 <- matrix (d18O_cellulose[["fo=0.33"]][["gs=0.5"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))

d18O__fo0.42_gs0.01 <-matrix ( d18O_cellulose[["fo=0.42"]][["gs=0.01"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.42_gs0.25 <- matrix (d18O_cellulose[["fo=0.42"]][["gs=0.25"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))
d18O__fo0.42_gs0.5 <- matrix (d18O_cellulose[["fo=0.42"]][["gs=0.5"]], nrow = 17, ncol = 16, byrow = F, dimnames = list(as.character(relH),as.character(water)))

COLIS <- colorRampPalette(colors = c("red", "blue", "black"))


```

```{r}

col_panel <- COLIS(10)
range_limits <- range(unlist(d18O_cellulose))

layout(mat = matrix(1:9,nrow = 3, ncol = 3, byrow = T), widths = 1, heights = 1, respect = T)
par(mar=c(4,4,0.1,0.1))

image(x = water, y = relH, z = t(d18O__fo0.33_gs0.01),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.33_gs0.25),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.33_gs0.5),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.42_gs0.01),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.42_gs0.25),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.42_gs0.5),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.55_gs0.01),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.55_gs0.25),col = col_panel, zlim = range_limits)
image(x = water, y = relH, z = t(d18O__fo0.55_gs0.5),col = col_panel, zlim = range_limits)



```

### Exercise
Considering the slopes between the d18O in cellulose and ```relH``` and ```water``` and the hypothetical range of variability on a given environment, what variable is most likely to be influencing the cellulose values throughout the life span of a tree?  Take into consideration the seasonal and interannual variability.

Case 1: The source water ranges from -10 to -5, and the relative humidity fluctuates between 20 to 70%. Here we will be assuming that the average gs is 0.01 and a 42% exchange.

Case 2: The source water varies from -10 to -8, and the relative humidity fluctuates between 80% to 90%. Here we will be assuming that the average gs is 0.01, and a 42% exchange.


Question xx: what is the most important variable in each of the cases? Can you say how much the source influences the cellulose and how much the relative humidity affects the outcome in d18O in cellulose?

Question xx: is there a significant difference between the d18O in cellulose when gs varies from 0.01 to 0.5? 
 
 





